<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Candy Crush風ゲーム＋クイズ＋LINE連携</title>
  <style>
    body { margin:0; padding:0; background:#333; display:flex; justify-content:center; align-items:center; height:100vh; }
    canvas { border:2px solid #000; background:#444; }
    #quizOverlay {
      position:absolute; top:0; left:0; width:640px; height:640px;
      background:rgba(0,0,0,0.7); display:none; flex-direction:column;
      justify-content:center; align-items:center; color:#fff; font-family:sans-serif;
      z-index:10;
    }
    #quizNumberImage { max-width:200px; margin-bottom:20px; display:none; }
    #quizOverlay input, #quizOverlay button {
      font-size:24px; margin-top:10px; padding:5px 10px;
    }
    #quizOverlay input { width:50%; text-align:center; }
  </style>

  <!-- LIFF SDK と設定 -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="640"></canvas>
  <div id="quizOverlay">
    <img id="quizNumberImage" src="" alt="Quiz Number">
    <div id="quizQuestion" style="font-size:24px;"></div>
    <input id="quizInput" type="text" placeholder="答えを入力">
    <button id="quizSubmit">送信</button>
    <div id="quizResult" style="margin-top:20px; font-size:24px;"></div>
  </div>

  <script>
  // --- LIFF 初期化 ---
  let LINE_USER_ID, LINE_ID_TOKEN;
  (async () => {
    await liff.init({ liffId: APP_CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: APP_CONFIG.LIFF_URL });
      return;
    }
    LINE_USER_ID  = liff.getContext().userId;
    LINE_ID_TOKEN = liff.getIDToken();
    initGame();
  })();

  // --- ポイント付与 ---
  async function awardPoints(points) {
    try {
      const res = await fetch(APP_CONFIG.AZURE_FUNCTION_URL, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization":"Bearer "+LINE_ID_TOKEN
        },
        body: JSON.stringify({ userId:LINE_USER_ID, points, scanInfo:{source:"candy-quiz",timestamp:new Date().toISOString()} })
      });
      console.log("awardPoints:", await res.json());
    } catch(e){ console.error(e); }
  }

  function initGame() {
    const { ROWS, COLS, TILE_SIZE, CANDY_TYPES, MAX_MOVES, CANDY_COLORS, ASSETS_PATH, QUIZ_LIST } = APP_CONFIG;

    const canvas = document.getElementById("gameCanvas");
    const ctx    = canvas.getContext("2d");
    let gameState, board, score, moveCount, selectedTile, lastQuizMove, doubleScore;
    const gameBackground = new Image();
    // bg_game.png が無い場合は candy0.png を背景に使う
    gameBackground.src = `${ASSETS_PATH}/candy0.png`;

    const candyImages = [];
    for (let i=0; i<CANDY_TYPES; i++) {
      let img = new Image();
      img.src = `${ASSETS_PATH}/candy${i}.png`;
      candyImages.push(img);
    }

    // --- ゲームユーティリティ ---
    function getRandomCandy(){ return Math.floor(Math.random()*CANDY_TYPES); }
    function createBoard(){
      return Array.from({length:ROWS}, ()=>Array.from({length:COLS}, getRandomCandy));
    }
    function findMatches(){
      const m=new Set();
      // 横チェック
      for(let i=0;i<ROWS;i++){
        let cnt=1;
        for(let j=1;j<COLS;j++){
          if(board[i][j]===board[i][j-1]) cnt++;
          else { if(cnt>=3) for(let k=j-cnt;k<j;k++) m.add(`${i},${k}`); cnt=1; }
        }
        if(cnt>=3) for(let k=COLS-cnt;k<COLS;k++) m.add(`${i},${k}`);
      }
      // 縦チェック
      for(let j=0;j<COLS;j++){
        let cnt=1;
        for(let i=1;i<ROWS;i++){
          if(board[i][j]===board[i-1][j]) cnt++;
          else { if(cnt>=3) for(let k=i-cnt;k<i;k++) m.add(`${k},${j}`); cnt=1; }
        }
        if(cnt>=3) for(let k=ROWS-cnt;k<ROWS;k++) m.add(`${k},${j}`);
      }
      return m;
    }
    function findConnectedGroups(set){
      const groups=[]; const vis=new Set();
      function dfs(key,grp){
        const [r,c]=key.split(",").map(Number);
        [[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr,nc])=>{
          const nk=`${nr},${nc}`;
          if(set.has(nk)&&!vis.has(nk)){ vis.add(nk); grp.add(nk); dfs(nk,grp); }
        });
      }
      set.forEach(key=>{
        if(!vis.has(key)){
          const grp=new Set([key]); vis.add(key); dfs(key,grp); groups.push(grp);
        }
      });
      return groups;
    }
    function removeMatches(set){
      set.forEach(k=>{ const [r,c]=k.split(",").map(Number); board[r][c]=null; });
    }
    function collapseBoard(){
      for(let j=0;j<COLS;j++){
        let col=board.map(r=>r[j]).filter(v=>v!==null);
        const miss=ROWS-col.length;
        col=Array.from({length:miss}, getRandomCandy).concat(col);
        for(let i=0;i<ROWS;i++) board[i][j]=col[i];
      }
    }
    function processMatches(){
      let total=0, m=findMatches();
      while(m.size){
        findConnectedGroups(m).forEach(g=> total+=(g.size-2)*30 );
        removeMatches(m); collapseBoard(); m=findMatches();
      }
      if(doubleScore){ total*=2; doubleScore=false; }
      score+=total;
    }
    function removeInitialMatches(){
      let m=findMatches();
      while(m.size){ removeMatches(m); collapseBoard(); m=findMatches(); }
    }
    function loadRanking(){
      const arr=JSON.parse(localStorage.getItem("ranking")||"[]");
      return arr.sort((a,b)=>b-a);
    }
    function updateRanking(s){
      const arr=loadRanking(); arr.push(s); arr.sort((a,b)=>b-a);
      localStorage.setItem("ranking", JSON.stringify(arr.slice(0,10)));
    }

    // --- クイズオーバーレイ ---
    const quizOverlay     = document.getElementById("quizOverlay");
    const quizNumImg      = document.getElementById("quizNumberImage");
    const quizQuestionEl  = document.getElementById("quizQuestion");
    const quizInput       = document.getElementById("quizInput");
    const quizSubmit      = document.getElementById("quizSubmit");
    const quizResult      = document.getElementById("quizResult");
    function startQuiz(cb){
      gameState="quiz";
      const q = QUIZ_LIST[Math.floor(Math.random()*QUIZ_LIST.length)];
      const m = q.question.match(/クイズ(\d+):/);
      if(m){ quizNumImg.src=`${ASSETS_PATH}/quiz${m[1]}.png`; quizNumImg.style.display="block"; gameBackground.src=quizNumImg.src; }
      else quizNumImg.style.display="none";
      quizQuestionEl.textContent=q.question; quizInput.value=""; quizResult.textContent=""; quizOverlay.style.display="flex";
      function finish(ok){
        quizOverlay.style.display="none"; gameState="game"; cb(ok);
      }
      function onSubmit(){
        const ans=quizInput.value.trim();
        quizResult.textContent=(ans===q.answer?"正解！":"不正解！");
        quizSubmit.removeEventListener("click", onSubmit);
        quizInput.removeEventListener("keydown", onKey);
        setTimeout(()=>finish(ans===q.answer),1500);
      }
      function onKey(e){ if(e.key==="Enter") onSubmit(); }
      quizSubmit.addEventListener("click", onSubmit);
      quizInput.addEventListener("keydown", onKey);
    }

    // --- 描画 ---
    function drawBoard(){
      for(let i=0;i<ROWS;i++){
        for(let j=0;j<COLS;j++){
          const v=board[i][j], x=j*TILE_SIZE, y=i*TILE_SIZE;
          if(v!==null && candyImages[v].complete && candyImages[v].naturalWidth){
            ctx.drawImage(candyImages[v], x, y, TILE_SIZE, TILE_SIZE);
          } else {
            ctx.fillStyle=CANDY_COLORS[v]||"white";
            ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);
          }
          ctx.strokeStyle="black"; ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);
        }
      }
      if(selectedTile){
        ctx.lineWidth=3; ctx.strokeStyle="white";
        ctx.strokeRect(selectedTile.col*TILE_SIZE,selectedTile.row*TILE_SIZE,TILE_SIZE,TILE_SIZE);
        ctx.lineWidth=1;
      }
    }
    function drawHomeScreen(){
      ctx.fillStyle="#303030"; ctx.fillRect(0,0,COLS*TILE_SIZE,ROWS*TILE_SIZE);
      ctx.fillStyle="white"; ctx.font="32px sans-serif";
      let title="Candy Crush風ゲーム"; ctx.fillText(title,(COLS*TILE_SIZE-ctx.measureText(title).width)/2,50);
      ctx.font="24px sans-serif"; let rt="ランキング"; ctx.fillText(rt,(COLS*TILE_SIZE-ctx.measureText(rt).width)/2,150);
      const ranks=loadRanking(); let y=200;
      if(ranks.length){
        ranks.forEach((s,i)=>{ const line=`${i+1}. ${s}`; ctx.fillText(line,(COLS*TILE_SIZE-ctx.measureText(line).width)/2,y); y+=30; });
      } else {
        const line="まだスコアはありません"; ctx.fillText(line,(COLS*TILE_SIZE-ctx.measureText(line).width)/2,y);
      }
      const instr="Pキー または クリックで開始";
      ctx.fillText(instr,(COLS*TILE_SIZE-ctx.measureText(instr).width)/2,ROWS*TILE_SIZE-50);
    }
    function drawGameScreen(){
      if(gameBackground.complete && gameBackground.naturalWidth){
        ctx.drawImage(gameBackground,0,0,COLS*TILE_SIZE,ROWS*TILE_SIZE);
      } else {
        ctx.fillStyle="#505050"; ctx.fillRect(0,0,COLS*TILE_SIZE,ROWS*TILE_SIZE);
      }
      drawBoard();
      ctx.fillStyle="white"; ctx.font="20px sans-serif";
      ctx.fillText(`Score: ${score}`,10,25);
      ctx.fillText(`Moves: ${moveCount} / ${MAX_MOVES}`,10,50);
    }
    function drawGameOverScreen(){
      ctx.fillStyle="#505050"; ctx.fillRect(0,0,COLS*TILE_SIZE,ROWS*TILE_SIZE);
      ctx.fillStyle="white"; ctx.font="36px sans-serif";
      let t="Game Over"; ctx.fillText(t,(COLS*TILE_SIZE-ctx.measureText(t).width)/2,ROWS*TILE_SIZE/2-80);
      let f=`Final Score: ${score}`; ctx.fillText(f,(COLS*TILE_SIZE-ctx.measureText(f).width)/2,ROWS*TILE_SIZE/2-40);
      ctx.font="24px sans-serif";
      let instr="Hキー：ホーム　　Pキー：もう一度";
      ctx.fillText(instr,(COLS*TILE_SIZE-ctx.measureText(instr).width)/2,ROWS*TILE_SIZE/2);
    }

    // --- 入力 & ループ ---
    function getTile(x,y){ return { row:Math.floor(y/TILE_SIZE), col:Math.floor(x/TILE_SIZE) }; }
    function areAdjacent(a,b){ return Math.abs(a.row-b.row)+Math.abs(a.col-b.col)===1; }

    canvas.addEventListener("click", async e=>{
      if(gameState==="home"){ startNewGame(); }
      else if(gameState==="game"){
        const rect=canvas.getBoundingClientRect(), t=getTile(e.clientX-rect.left,e.clientY-rect.top);
        if(!selectedTile) selectedTile=t;
        else if(areAdjacent(selectedTile,t)){
          const [r1,c1]=[selectedTile.row,selectedTile.col], [r2,c2]=[t.row,t.col];
          [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
          if(findMatches().size){
            moveCount++; processMatches();
            if([0,5,10,15].includes(moveCount)&&moveCount!==lastQuizMove){
              lastQuizMove=moveCount; startQuiz(res=>doubleScore=res);
            }
          } else {
            [board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
          }
          selectedTile=null;
          if(moveCount>=MAX_MOVES){
            updateRanking(score);
            await awardPoints(score);
            gameState="gameOver";
          }
        }
      }
    });

    document.addEventListener("keydown", e=>{
      if(gameState==="home"&&e.key.toLowerCase()==="p") startNewGame();
      if(gameState==="gameOver"){
        if(e.key.toLowerCase()==="h") gameState="home";
        if(e.key.toLowerCase()==="p") startNewGame();
      }
    });

    function startNewGame(){
      gameBackground.src=`${ASSETS_PATH}/candy0.png`;
      board=createBoard(); removeInitialMatches();
      score=0; moveCount=0; selectedTile=null; lastQuizMove=-1; doubleScore=false;
      // 最初のクイズ
      startQuiz(res=>{ doubleScore=res; lastQuizMove=0; gameState="game"; });
    }

    function gameLoop(){
      if(gameState==="home") drawHomeScreen();
      else if(gameState==="game"||gameState==="quiz") drawGameScreen();
      else if(gameState==="gameOver") drawGameOverScreen();
      requestAnimationFrame(gameLoop);
    }

  } // end initGame
  </script>
</body>
</html>
